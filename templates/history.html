{% extends "layout.html" %}

{% block title %}
History
{% endblock %}

{% block main %}

<button id="exportTableButton" onClick = "exportTableToExcel()"> Exportar para Excel</button>

<h3>Filtrar</h3>
<form action="/history" method="post">
    <div>
        <select name="obra">
            <option value="todas">Todas</option>
            {% for obra in obras_mapeadas %}
            <option value="{{ obra }}">{{ obra }}</option>
            {% endfor %}
        </select>
    </div>
    <div>
        <select name="year">
            <option value="todos">Todos</option>
            {% for year in years %}
            <option value="{{ year.year }}">{{ year.year }}</option>
            {% endfor %}
        </select>
    </div>
    <div>
        <br></br>
        <p> Filtrar por AP e recolhas na Sede? </p>
        <select name="ligar_egars">
            <option value="NA">Não</option>
            <option value="Ligar">Sim</option>
        </select>
    </div>
    <br></br>
    <button type="submit">Aplicar</button>
</form>


<table id="tableId" style="width:100%">
    <thead>
        <tr>
            <th>Data</th>
            <th>N.º e-GAR</th>
            <th>Obra</th>
            <th>APA Estab.</th>
            <th>Transp.</th>
            <th>NIF Transp.</th>
            <th>Matrícula</th>
            <th>APA Transp.</th>
            <th>Código LER</th>
            <th>Resíduo</th>
            <th>Qtd(ton.)</th>
            <th>Destino Final</th>
            <th>Dest.</th>
            <th>NIF Dest.</th>
            <th>APA Dest.</th>
            <th>Produtor</th> 
        </tr>
    </thead>
    <tbody>
        {% for row in map %}
        <tr>
            <td>{{ row.data }}</td>
            <td>{{ row.egar }}</td>
            <td>{{ row.obra }}</td>
            <td>{{ row.apa_estab }}</td>
            <td>{{ row.transp }}</td>
            <td>{{ row.nif_transp }}</td>
            <td>{{ row.matricula }}</td>
            <td>{{ row.apa_transp }}</td>
            <td>{{ row.codLER }}</td>
            <td>{{ row.residuo }}</td>
            <td>{{ row.ton }}</td>
            <td>{{ row.dest_final }}</td>
            <td>{{ row.dest }}</td>
            <td>{{ row.nif_dest }}</td>
            <td>{{ row.apa_dest }}</td>
            <td>{{ row.produtor }}</td>
            <td>
                <button class="delete_button" onclick="showConfirmDelete('{{ row.id }}')">Apagar</button>
                <form id="deleteEGAR{{ row.id }}" action="/delete" method="post" style="display: none;">
                    <div>
                        <input name="row_id" type="hidden" value="{{ row.id }}">
                    </div>
                    <div>
                        <input name="obra" type="hidden" value="{{ row.obra }}">
                    </div>
                    <p>Pretende mesmo eliminar? A ação será irreversível</p>
                    <div>
                        <button type="submit">Confirmar</button>
                    </div>
                    <br>
                    <div>
                        <button type="button" onclick="hideConfirmDelete('{{ row.id }}')"> Cancelar </button>
                    </div>
                </form>
            </td>
            <td>
                <button class="edit_button" onclick="showEditForm('{{ row.id }}')">Editar</button>
                <form id="showForm{{row.id}}" action="/edit_egar" method="post" style="display: none;">
                    <div>
                        <input name="row_id" type="hidden" value="{{ row.id }}">
                    </div>
                    <div>
                        <input name="nova_data" value="{{row.data}}" type="date">
                    </div>
                    <div>
                        <input name="nova_egar" value="{{row.egar}}" type="text">
                    </div>
                    <div>
                        {% if obras_mapeadas %}
                        <select name="nova_obra">
                            {% for obra in obras_mapeadas %}
                            <option value="{{ obra }}" {% if obra==row.obra %}selected{% endif %}>{{ obra }}</option>
                            {% endfor %}
                        </select>
                        {% else %}
                        <p>Nenhuma obra disponível</p>
                        {% endif %}
                    </div>
                    <div>
                        <select name="novo_apa_associado" class="form-control mx-auto w-auto" >
                            <option value="estab" {% if row.apa_estab != "GT" %}selected{% endif %}>APA do Estabelecimento</option>
                            <option value="GT" {% if row.apa_estab == "GT" %}selected{% endif %}>GT - APA Geral Tecnorém</option>
                        </select>
                    </div>
                    <div>
                        <input name="novo_transp" value="{{row.transp}}" type="text">
                    </div>
                    <div>
                        <input name="novo_nif_transp" value="{{row.nif_transp}}" type="number" min="99999999"
                            max="999999999">
                    </div>
                    <div>
                        <input name="nova_matricula" value="{{row.matricula}}" type="text">
                    </div>
                    <div>
                        <input name="novo_apa_transp" value="{{row.apa_transp}}" type="text">
                    </div>
                    <div>
                        <select name="novo_codLER">
                            {% for codLER in todos_codLer %}
                            <option value="{{ codLER }}" {% if codLER == row.codLER %}selected{% endif %}>{{ codLER }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <input name="nova_ton" value="{{row.ton}}" type="number" min="0.001" step="0.001">
                    </div>
                    <div>
                        <select name="novo_dest_final">
                            {% for dest_final in dest_finais %}
                            <option value="{{ dest_final }}" {% if dest_final == row.dest_final %}selected{% endif %}>{{ dest_final }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <input name="novo_dest" value="{{row.dest}}" type="text">
                    </div>
                    <div>
                        <input name="novo_nif_dest" value="{{row.nif_dest}}" type="number" min="99999999"
                            max="999999999">
                    </div>
                    <div>
                        <input name="novo_apa_dest" value="{{row.apa_dest}}" type="text">
                    </div>
                    <div>
                        <select name="novo_produtor">
                            <option value="Outro">Outro (Empresa fora do Grupo Tecnorém) </option>
                            {% for produtor in produtores %}
                            <option value="{{produtor}}" {%if produtor == row.produtor %}selected{% endif %}> {{ produtor }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <button type="submit">Aplicar alterações</button>
                </form>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<script>
    function showConfirmDelete(rowId) {
        var rowForDeleting = "deleteEGAR" + rowId;
        var deletingForm = document.getElementById(rowForDeleting);
        if (deletingForm) {
            deletingForm.style.display = deletingForm.style.display === 'none' ? 'block' : 'none';
        }
    }

    function hideConfirmDelete(rowId) {
        document.getElementById('deleteEGAR' + rowId).style.display = 'none';
    }

    function showEditForm(rowId) {
        var rowForEdition = 'showForm' + rowId;
        var editingForm = document.getElementById(rowForEdition);
        if (editingForm) {
            editingForm.style.display = editingForm.style.display === 'none' ? 'block' : 'none';
        }
    }

    function exportTableToExcel(){
        const tableToExport = document.getElementById('tableId')
        const workbook = XLSX.utils.table_to_book(tableToExport);
        XLSX.writeFile(workbook,"GestResProduzidos_dd-mm-aaaa.xlsx");

    }

</script>

{% endblock %}